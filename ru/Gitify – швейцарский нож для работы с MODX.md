# Gitify – швейцарский нож для работы с MODX

![Gitify – швейцарский нож для работы с MODX](https://dl.dropboxusercontent.com/u/4331938/gitify-swis-knife.jpg)

Все, кто когда-либо работал над большим MODX сайтом с несколькими стадиями жизни проекта (dev, test/stage, production) или пробовал работать над таким сайтом в команде, обязательно сталкивались с основным недостатком MODX – сохранением элементов кода в базе данных, и как следствие, отсутствием вменяемых способов использовать систему контроля версий. Найдутся те, кто скажут, что это не самая главная проблема и они её решили так-то и так-то и будут правы. На сегодня решений данной проблемы существует уже более 5 (мне известных) и все они разной степени костыльности, включая и Gitify, о котором ниже пойдет речь. Но костыль с моторчиком ;)

Под катом особенности установки и применения Gitify, а также  боевые примеры.

=== кат ===

В самом MODX есть статические элементы, призванные частично решить проблему сохранения кода в БД, но выглядит все это малопригодным для каждодневного использования. Возможность сохранять есть, но функций со стороны панели управления, позволяющих как-то упростить этот процесс, нет. По этой причине мной в свое время был создан [SE Manager](http://modx.com/extras/package/semanagerformodx), который частично эту проблему решал. Примерно с той же целью был создан [Teleport](https://github.com/modxcms/teleport) (я о нем рассказывал на прошлогоднем MODX Meetup Minsk), который немного по другому, но решает ту же проблему: собирает все в пакет на одной копии MODX и переносит её на другую. Teleport решает это через родные для MODX транспортные пакеты. Те же пакеты, через которые распространяются все дополнения. Конечно, существует еще несколько решений и подходов, но о них в другой раз.

## Но что же Gitify?

После полугода активного использования скажу, что такой же костыль, хотя и несколько удобнее остальных. Тем не менее задачу решает и решает, на удивление, хорошо, хотя без моей помощи не обошлось.

Gitify – это набор команд (функций), помогающих в работе с сайтом на MODX. И это буквально. Каждая функция — это отдельный класс и отдельная команда, которая отвечает только за ту область деятельности, для которой создавалась.

[Первый комит](https://github.com/modmore/Gitify/commit/30f3bf181204934cc2c5cfeb256617f6ba8a6b51) в репозиторий был сделан 1 июня 2014 года. Марк Хамстра анонсировал данный инструмент на большой конференции MODX Weekend в сентябре 2014. Летом этого года я перевел [документацию](http://modmore.github.io/Gitify/ru/) на русский язык, но видимо этого мало, разработчики не до конца осознают пользу gitify. Что ж, попробуем исправить ситуацию.

Основная задача Gitify – это собрать элементы действующего сайта в понятный человеку формат, сохранить в файлы и точно так же восстановить сайт из файлов, но уже в другом месте (на боевом сервере, например). Важное в этом процессе — читаемый формат и то, что версиями этих файлов можно управлять посредством git и других VCS.

> Читаемость кода крайне важна при работе в команде. При должном подходе к работе и рабочему процессу, обязательно должна быть стадия code review. Code review позволяет максимально быстро обмениваться опытом между участниками команды и учиться у коллег. К тому же code review избавляет от нелепых ошибок, которые видят коллеги, но которые разработчик мог пропустить из-за усталости или из-за того, что давно работает с участком кода и глаз замылился. Транспортные пакеты, которые создает Teleport, малопригодны в таком случае, а вот код, генерируемый Gitify, полностью доступен и понятен (исходники и немного конфигурационных файлов в yaml).

Уверен, что понятнее не стало, поэтому предлагаю установить Gitify и попробовать все на практике.

## Установка

Gitify написан на PHP и для работы требует PHP версии не ниже 5.3 в cli-режиме. Так же для установки требуется composer. Если вы еще не в курсе, что это такое, то пора бы узнать, иначе останетесь на задворках современной web-разработки.

> Я привожу примеры установки для MacOS/Linux, Windows у меня нет, но если у вас стоит [GitBash](https://git-for-windows.github.io/), то скорее всего проблем не будет, разве что пути нужно будет немного по другому писать.

### Установка Composer

Идем по [этой ссылке](https://getcomposer.org/doc/00-intro.md) и устанавливаем composer в систему. Подробнее описывать не стану, тема гуглится в один клик.

### Установка Gitify

Чтобы установить Gitify, достаточно клонировать репозиторий в удобную для вас папку, и запустить команду `composer install` внутри этой папки. Либо скачать composer.phar в папку и запустить `php composer.phar install`, если с установкой composer налажали. Чтобы не писать каждый раз полный путь к папке с Gitify, можно добавить путь в переменную окружения $PATH. Делается это так:

```bash
export PATH=/path/to/Gitify/:$PATH
```

Либо можно добавить alias в терминал. Я пользуюсь zsh, поэтому добавил в файл `~/.zshrc` строку `alias gitify=“php /path/to/gitify/Gitify”`. Если решили запускать Gitify из папки, то следует дать права на запуск:

```bash
chmod +x Gitify
```

На этом все. Попробуйте запустить `gitify`, результат должен получиться примерно такой:

```bash
Gitify version 0.11.0

Usage:
 command [options] [arguments]

Options:
 —help (-h)           Display this help message.
 —verbose (-v|vv|vvv) Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug.
 —version (-V)        Display the Gitify version.

Available commands:
 backup            Creates a quick backup of the entire MODX database. Runs automatically when using `Gitify build —force`, but can also be used manually.
 build             Builds a MODX site from the files and configuration.
 clearcache        Clears the internal Gitify cache.
 extract           Extracts data from the MODX site, and stores it in human readable files for editing and committing to a VCS.
 help              Displays help for a command
 init              Generates the .gitify file to set up a new Gitify project. Optionally installs MODX as well.
 list              Lists commands
 restore           Restores the MODX database from a database dump created by `Gitify backup`
install
 install:modx      Downloads, configures and installs a fresh MODX installation. [Note: install:modx will be removed in 1.0, use modx:install instead]
 install:package   Downloads and installs MODX packages. [Note: install:package will be removed in 1.0, use package:install instead]
modx
 modx:install      Downloads, configures and installs a fresh MODX installation. [Note: install:modx will be removed in 1.0, use modx:install instead]
 modx:upgrade      Downloads, configures and updates the current MODX installation.
package
 package:install   Downloads and installs MODX packages. [Note: install:package will be removed in 1.0, use package:install instead]
```

> Далее в примерах я буду вызывать Gitify, как уже добавленный alias, т.е. просто `gitify`.

Не секрет, что большинство сайтов располагаются на обычных shared-хостингах и хорошо бы иметь возможность пользоваться Gitify и на них. Хостинг должен соответствовать некоторым требованиям: иметь доступ по ssh, иметь установленный git, должен быть включен PHP модуль для работы с phar-архивами и установлена команда unzip. Как правило, большинство современных хостингов предоставляют такие услуги. Если не сразу, то включают по запросу. Если нет, то мой совет, меняйте хостинг. +10-50 рублей к цене в месяц погоды не сделают, а время и нервы сэкономите.

Чтобы установить gitify на хостинг, нужно скачать composer.phar, склонировать Gitify и настроить алиасы:

```
wget https://getcomposer.org/composer.phar
git clone https://github.com/modmore/Gitify.git
```

Затем добавить две строки в самый конец файла ~/.bashrc

```bash
alias composer=‘php-cli /home/inoutby/bin/composer’
alias gitify=‘php-cli /home/inoutby/gitify/Gitify’
```

Не забыть сделать `composer install` внутри папки Gitify и можно пользоваться.

Подробнее про установку можно посмотреть в документации: http://modmore.github.io/Gitify/ru/installation/installation.html

## Конфигурация

Без конфигурации, конечно же, никуда, но в Gitify она простая, я бы сказал, слишком простая. Для работы Gitify требуется один файл конфигурации в корне с сайтом — `.gitify`. В этом файле описываются те сущности, которые требуется сохранить из действующего сайта и развернуть на том, где это нужно.

Подробно устройство файла конфигурации описано в документации: http://modmore.github.io/Gitify/ru/config/the-gitify-file.html

Перед началом работы над сайтов требуется создать файл конфигурации. Можно это сделать вручную, но рекомендую использовать специальную команду `gitify init`, которая в интерактивном режиме собирает актуальную информацию о проекте и создает подготовленный .gitify-файл, который потом можно легко настроить под свои нужды.

У команды есть только один параметр `—overwrite` (коротко `-o`), который обозначает, что нынешний файл конфигурации, если он существует, будет перезаписан новым.

Помимо файла конфигурации gitify в момент инициализации создает две папки: `_data` и `_backup`. В первой будет хранится сущности сайта, преобразованные командой extract в файлы, в другой — бекапы базы данных, созданные командой backup. Эти названия используются по умолчанию, но можно определить и свои.

## Основные команды

Каждая команда отвечает за свою область действий и призвана решать только свой круг задач. Парные команды как правило зеркальны и выполняют похожие, но обратные по значимости действия. Тем не менее каждая команда сильно экономит время и ресурсы, которые раньше приходилось тратить на рутинные операции.

### extract и build

Пожалуй, ради этих двух команд Gitify и затевался как проект. **extract** позволяет вытащить из базы данных все сущности, описанные в конфиге .gitify и сохранить в файлы. **build** делает обратную операцию — записывает содержимое файлов в базу данных, удаляет не нужные элементы, создает недостающие, управляет конфликтами.

Давайте начнем с более простой команды extract. Допустим, у нас в конфигурации описаны только чанки:

```yaml
data_directory: _data/
data:
		chunks:
        class: modChunk
        primary: name
        extension: .html
```

Команда extract в папке _data создаст папку chunks, затем найдет все объекты элементы класса modChunk и сохранит их в эту папку. В качестве имени будет использоваться поле name из таблицы с чанками (имя чанка), расширение у файлов будет .html. 

По умолчанию команда extract преобразует в файлы все описанные в конфигурации сущности, перезаписывая значения в файлах (это не страшно, так как файлы как правило контролируются git и всегда можно откатить изменения). Но на больших сайта это может занимать длительное время. Поэтому можно указать в качестве аргументов только некоторые категории, которые нужно выгрузить. Например, сохранить только чанки и снипеты:

```bash
gitify extract chunks snippets
```

После того, как данные сохранены в файлы, мы можем редактировать их через IDE, если пожелаем, или добавить в git и отправить изменения в репозиторий, где их увидят другие разработчики.

А теперь о build.

=== написать самый сок ===

### backup и restore

Команда **backup** сохраняет содержимое базы данных текущего сайта в файл в формате sql. Эта команда автоматически запускается, когда используется команда build c параметром `—force`. Полученный файл — обыкновенный дамп базы данных, аналогичный тому, который генерирует phpmyadmin, например.

Команда backup в качестве аргумента может принимать имя файла, в который следует сохранить дамп. По умолчанию именем файла является текущая дата и время.

Так же у команды есть параметр `—overwrite` (коротко `-o`), который предписывает gitify перезаписать содержимое файла бекапа, если файл с таким именем уже существует.

Команда **restore** восстанавливает содержимое базы данных файла из бекапа. В качестве аргумента может принимать имя файла с бекапом. В случае, если имя не указано, данная команда предлагает выбрать бекап для восстановления в интерактивном режиме. Так же существует возможность вместо имени файла указать ключевое слово “last”, тогда будет выбран последний созданный бекап (анализируется время изменения файла).

### modx:install, modx:upgrade, clearcache

Данные команды позволяют установить MODX и обновить текущую версию, в случае, если он уже установлен. Принцип работы весьма прост. Команда скачивает последнюю версию (можно задать конкретную версию через аргумент version в формате 2.3.2-pl) MODX c официального сайта, распаковывает архив и запускает установку или обновление.

При первой установке Gitify работает в интерактивном режиме, позволяя задать настройки подключения к базе данных и данные администратора в момент установки. При обновлении настройки уже известны, поэтому просто происходит процесс обновления.

Для случая, когда у вас много сайтов на MODX, Gitify умеет кешировать архив с MODX на диск, чтобы не скачивать каждый раз новый. Данная функция включена по умолчанию, но имеется возможность принудительно заставить gitify скачивать новый архив, указав параметр `—download`.

Несколько примеров использования команды:

```bash
; Установить MODX в текущую папку
gitify modx:install
; Установить MODX версии 2.4.1-pl
gitify modx:install 2.4.1-pl
; Скачать новый архив и установить MODX
gitify modx:install —download
; Обновить MODX
gitify modx:upgrade
; Скачать новый архив версии 2.4.2-pl и обновить MODX до этой версии
gitify modx:upgrade 2.4.2-pl -d
```

Команда **clearcache** работает аналогично одноименной команде из composer и удаляет все сохраненные после установки и обновления архивы MODX из внутренней папки gitify. 

### package:install

=== описание команды install пакетов ===

> Возможно вы успели заметить, что есть еще секция install и команды **install:modx** и **install:package**. Эти команды устаревшие и являются всего лишь алиасами к командам **modx:install** и **package:install** соответственно. Их использование не рекомендуется, так как они будут удалены в ближайшее время.

Проект развивается, поэтому со временем у команд могут появится новые аргументы и параметры, которые еще не описаны в документации. Чтобы увидеть список аргументов и параметров, достаточно выполнить команду с параметром `—help`: 

```bash
gitify modx:backup —help
```

## Что можно делать с Gitify

Давайте рассмотрим реальные ситуации из жизни проектов и попробуем написать сценарии по применению Gitify.

### Устанавливаем MODX через Gitify и начинаем работу над сайтом через IDE

### Уже есть рабочий сайт, нужно перевести его на gitify-рельсы, чтобы использовать git

### Нужно сохранять состояния сайта и следить за тем, какие изменения на нем происходят

### Нужно организовать работу команды над MODX проектом

### Нужно настроить несколько копий сайта для разных задач: dev, stage/test, production

Это лишь небольшой список случае возможного применения Gitify, который я придумал и который я опробовал на практике сам. Возможно, вы найдете другие.

## Вердикт

О Gitify в сообществе пока мало кто знает, несмотря на наличие документации на русском. Хотя уверен, что именно эту статью все ждали с нетерпением, чтобы начать работать с Gitify. Опытные разработчики уже используют свои настроенные и проверенные решения, а новичкам пока не до проблем сопровождения, научиться бы просто сайты собирать. А что делать обычным ремесленникам? Мой ответ - пробовать Gitify. По моему мнению, на сегодня это пока что лучший инструмент для управления MODX сайтом.

Gitify как проект активно развивается. [С недавнего времени](https://twitter.com/mark_hamstra/status/653956905031872512) я так же являюсь официальным разработчиков Gitify, поэтому вопросы и пожелания, а так же сообщения об ошибках можно слать мне. Конечно, у нас с Марком хватает своей работы, и мы не можем уделять все время этому проекту, но стараемся улучшать инструмент, с которым приходится работать каждый день. 

Спасибо за внимание!

